<script lang="ts">
  import ParquetPreview from "../../../lib/components/parquet-preview.svelte";
  import CsvPreview from "../../../lib/components/csv-preview.svelte";
  import GeopackagePreview from "../../../lib/components/geopackage-preview.svelte";
  import HtmlPreview from "../../../lib/components/html-preview.svelte";
  import { getSelection } from "../../../core/state/workspace.svelte.js";
  import { getResultFile } from "../store.svelte.js";

  // Get selected result
  const selectedResultId = $derived(getSelection('result'));
  const selectedResult = $derived(selectedResultId ? getResultFile(selectedResultId) : null);
</script>

{#if selectedResult}
  <!-- Result Preview Mode -->
  <div class="h-full min-h-0 overflow-hidden">
    {#if selectedResult.fileType === 'html' || selectedResult.fileType === 'htm'}
      <HtmlPreview
        htmlContent={selectedResult.content ? (typeof selectedResult.content === 'string' ? selectedResult.content : new TextDecoder().decode(selectedResult.content)) : ''}
        filename={selectedResult.filename}
        fileSize={selectedResult.fileSize}
        createdAt={selectedResult.createdAt}
        onDownload={() => {
          console.log('Download result:', selectedResult.filename);
        }}
      />
    {:else if selectedResult.fileType === 'csv'}
      <!-- Convert result to File object for CSV preview -->
      {#if selectedResult.content}
        {@const resultFile = new File([selectedResult.content], selectedResult.filename, { 
          type: 'text/csv',
          lastModified: new Date(selectedResult.createdAt).getTime()
        })}
        <CsvPreview 
          file={resultFile} 
          filename={selectedResult.filename} 
        />
      {/if}
    {:else if selectedResult.fileType === 'parquet' || selectedResult.fileType === 'pq'}
      <!-- Convert result to File object for parquet preview -->
      {#if selectedResult.content}
        {@const resultFile = new File([selectedResult.content], selectedResult.filename, { 
          type: 'application/octet-stream',
          lastModified: new Date(selectedResult.createdAt).getTime()
        })}
        <ParquetPreview 
          file={resultFile} 
          filename={selectedResult.filename} 
        />
      {/if}
    {:else if selectedResult.fileType === 'gpkg'}
      <!-- Convert result to File object for GeoPackage preview -->
      {#if selectedResult.content}
        {@const resultFile = new File([selectedResult.content], selectedResult.filename, { 
          type: 'application/geopackage+sqlite3',
          lastModified: new Date(selectedResult.createdAt).getTime()
        })}
        <GeopackagePreview 
          file={resultFile} 
          filename={selectedResult.filename} 
        />
      {/if}
    {:else}
      <!-- Generic file preview for other types -->
      <div class="flex items-center justify-center h-full">
        <div class="text-center">
          <div class="text-6xl mb-4">ðŸ“„</div>
          <h3 class="text-lg font-medium mb-2">{selectedResult.filename}</h3>
          <p class="text-muted-foreground mb-4">
            {selectedResult.fileType.toUpperCase()} file â€¢ {(selectedResult.fileSize / 1024).toFixed(1)} KB
          </p>
          <p class="text-sm text-muted-foreground">
            {selectedResult.description || 'Generated file from script execution'}
          </p>
        </div>
      </div>
    {/if}
  </div>
{:else}
  <!-- No result selected -->
  <div class="bg-muted/50 flex-1 rounded-xl overflow-auto">
    <div class="p-8">
      <h1 class="text-3xl font-bold mb-4">Script Results</h1>
      <p class="text-lg text-muted-foreground mb-6">
        View and download files generated by Python script execution.
        The sidebar shows all available result files with download options.
      </p>
      <div class="space-y-4">
        <h2 class="text-xl font-semibold">Features:</h2>
        <ul class="list-disc list-inside space-y-2 text-muted-foreground">
          <li>Real-time file preview for multiple formats</li>
          <li>Individual and batch file download capabilities</li>
          <li>Support for CSV, Parquet, HTML, and GeoPackage files</li>
          <li>File search and filtering by name or type</li>
          <li>Automatic file metadata and descriptions</li>
          <li>Integration with script execution tracking</li>
        </ul>
        <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-950/20 rounded-lg border">
          <h3 class="font-medium text-blue-900 dark:text-blue-100 mb-2">
            Getting Started
          </h3>
          <p class="text-sm text-blue-700 dark:text-blue-300">
            Execute Python scripts to generate result files. Files will appear here automatically
            and can be previewed by clicking on them, or downloaded individually or in bulk.
          </p>
        </div>
      </div>
    </div>
  </div>
{/if}
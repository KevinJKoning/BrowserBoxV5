<script lang="ts">
  import { PreviewRenderer, initializeBuiltinPreviews } from "../../../core/services/preview/index.js";
  import { getSelection } from "@core/state/workspace.svelte";
  import { getResultFile } from "../store.svelte";
  import { onMount } from "svelte";

  // Initialize built-in preview components
  onMount(() => {
    initializeBuiltinPreviews();
  });

  // Get selected result
  const selectedResultId = $derived(getSelection('result'));
  const selectedResult = $derived(() => selectedResultId ? getResultFile(selectedResultId) : null);
  
  // Create preview props for result file
  const previewProps = $derived((): Record<string, unknown> => {
    const result = selectedResult();
    if (!result?.content) return {};

    // Create File object from content for preview
    const parts: BlobPart[] = [result.content];
    const file = new File(parts, result.filename, {
      type: getMimeType(result.filename),
      lastModified: new Date(result.createdAt).getTime()
    });

    return {
      file,
      fileSize: result.fileSize,
      createdAt: result.createdAt
    };
  });
  
  function getMimeType(filename: string): string {
    const ext = filename.toLowerCase().split('.').pop() || '';
    const mimeTypes: Record<string, string> = {
      'csv': 'text/csv',
      'html': 'text/html',
      'htm': 'text/html',
      'parquet': 'application/octet-stream',
      'pq': 'application/octet-stream',
      'gpkg': 'application/geopackage+sqlite3',
      'geopackage': 'application/geopackage+sqlite3',
      'txt': 'text/plain',
      'json': 'application/json'
    };
    return mimeTypes[ext] || 'application/octet-stream';
  }
</script>

{#if selectedResult()}
  <!-- Result Preview Mode -->
  <div class="h-full min-h-0 overflow-hidden">
    <PreviewRenderer 
      filename={selectedResult()?.filename} 
      previewProps={previewProps()}
      fallbackMessage="No preview available for this file type. Generated file from script execution."
    />
  </div>
{:else}
  <!-- No result selected -->
  <div class="bg-muted/50 flex-1 rounded-xl overflow-auto border border-border">
    <div class="p-8">
      <h1 class="text-3xl font-bold mb-4">Script Results</h1>
      <p class="text-base text-muted-foreground mb-6">
        View and download files generated by Python script execution.
        The sidebar shows all available result files with download options.
      </p>
      <div class="space-y-4">
        <h2 class="text-lg font-semibold">Features:</h2>
        <ul class="list-disc list-inside space-y-2 text-sm text-muted-foreground">
          <li>Real-time file preview for multiple formats</li>
          <li>Individual and batch file download capabilities</li>
          <li>Support for CSV, Parquet, HTML, and GeoPackage files</li>
          <li>File search and filtering by name or type</li>
          <li>Automatic file metadata and descriptions</li>
          <li>Integration with script execution tracking</li>
        </ul>
        <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-950/20 rounded-lg border">
          <h3 class="font-medium text-blue-900 dark:text-blue-100 mb-2">
            Getting Started
          </h3>
          <p class="text-sm text-blue-700 dark:text-blue-300">
            Execute Python scripts to generate result files. Files will appear here automatically
            and can be previewed by clicking on them, or downloaded individually or in bulk.
          </p>
        </div>
      </div>
    </div>
  </div>
{/if}
